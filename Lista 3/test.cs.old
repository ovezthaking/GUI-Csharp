using System;
using System.Collections.Generic;
using System.Linq;

public delegate void NowyObserwatorHandler(string nazwa, double x, double y);
public delegate void WypiszHandler();

public class Obserwator
{
    private string nazwa;
    private double x, y;
    private List<(string Nazwa, double X, double Y, double Odleglosc)> sasiedzi;

    public Obserwator(string nazwa, double x, double y)
    {
        this.nazwa = nazwa;
        this.x = x;
        this.y = y;
        this.sasiedzi = new List<(string, double, double, double)>();
    }

    public void NowyObserwator(string nowaNazwa, double noweX, double noweY)
    {
        if (nowaNazwa != this.nazwa) // Only process observers created after this one
        {
            double odleglosc = Math.Sqrt(Math.Pow(noweX - x, 2) + Math.Pow(noweY - y, 2));
            sasiedzi.Add((nowaNazwa, noweX, noweY, odleglosc));
            sasiedzi.Sort((a, b) => a.Odleglosc.CompareTo(b.Odleglosc));
            if (sasiedzi.Count > 2)
            {
                sasiedzi = sasiedzi.Take(2).ToList();
            }
        }
    }

    public void Wypisz()
    {
        Console.WriteLine($"Jestem {0} - lista sasiadów:", nazwa);
        if (sasiedzi.Count == 0)
        {
            Console.WriteLine("  Brak sąsiadów");
        }
        else
        {
            foreach (var sasiad in sasiedzi)
            {
                Console.WriteLine($"  {sasiad.Nazwa} x={sasiad.X:F3} y={sasiad.Y:F3} odl={sasiad.Odleglosc:F3}");
            }
        }
    }
}

public class Tworca
{
    private List<Obserwator> obserwatorzy = new List<Obserwator>();
    private Random random = new Random();
    public event NowyObserwatorHandler Nowy;
    public event WypiszHandler Wypisz;

    public void StworzObserwatora(string nazwa)
    {
        double x = random.NextDouble();
        double y = random.NextDouble();
        Obserwator nowyObserwator = new Obserwator(nazwa, x, y);
        obserwatorzy.Add(nowyObserwator);

        // Subscribe the new observer to events
        Nowy += nowyObserwator.NowyObserwator;
        Wypisz += nowyObserwator.Wypisz;

        // Notify all existing observers about the new one
        Nowy?.Invoke(nazwa, x, y);
    }

    public void WypiszWszystkich()
    {
        Wypisz?.Invoke();
    }
}

class Program
{
    static void Main(string[] args)
    {
        Tworca tworca = new Tworca();
        int krok = 0;

        // Test program: create 4 observers over 4 steps
        for (int i = 0; i < 4; i++)
        {
            Console.WriteLine($"-----------krok {krok}-----------");
            if (i > 0)
            {
                tworca.WypiszWszystkich();
            }
            tworca.StworzObserwatora($"Obs {i}");
            krok++;
        }
        Console.WriteLine($"krok {krok}");
        tworca.WypiszWszystkich();
    }
}